{% extends 'visko2/base.html' %}
{% load staticfiles %}


{% block content %}
<h1 class="page-header">Integrated Semantic Framework</h1>

<form method="POST" action="{% url 'visko2:isf' %}">
  {% csrf_token %}
    <div class="input-group input-group-lg">
      <input class="form-control input-lg" name="input_sentence" id="input_sentence" placeholder="Some dogs bark." value="{{ input_sentence|default:'' }}" type="text">
      <span class="input-group-addon">Parse Count</span>
      <select id="input_results" name="input_results" class="form-control input-small" title="Maximum parses">
        {% for r in RESULTS %}
        <option {% if r == input_results %}selected="selected"{% endif %} value="{{r}}">{{r}}</option>
        {% endfor %}
      </select>
      <span class="input-group-btn">
        <button class="btn btn-default btn-lg" name="action" type="submit" value="cached">Parse</button>
      </span>
    </div>
</form>

{% if sent %}
<div class="dmrs_sentence_text">Parse count: {{ sent|length }}</div>
<div id="dmrs_text_holder" class="dmrs_sentence_text">{{ input_sentence }}</div>

<!-- Synset Information -->
<div id="synsets"></div>

<ul class="nav nav-tabs">
  <li><a data-toggle="tab" href="#visko">DMRS</a></li>
  <li class="active"><a data-toggle="tab" href="#delviz">delphin-viz</a></li>
  <li><a data-toggle="tab" href="#raw">pyDelphin</a></li>
  <li><a data-toggle="tab" href="#xml">XML</a></li>
  <li><a data-toggle="tab" href="#json">JSON</a></li>
</ul>
<div class="tab-content">
  <div id="visko" class="tab-pane">
    <div style="overflow-y: auto; height: 600px;">
      {% for parse in sent %}
      <h3>Parse #{{forloop.counter}}</h3>
      <div id='dmrs_canvas{{forloop.counter}}'></div>
      {% endfor %}
    </div>
  </div>
  <div id="delviz" class="tab-pane active">
    <div style="overflow-y: auto; height: 600px;">
      {% for parse in sent %}
      <h3>Parse #{{forloop.counter}}</h3>
      <div id='viszone{{forloop.counter}}'></div>
      {% endfor %}
    </div>
  </div>
  <div id="raw" class="tab-pane">
    {% for parse in sent %}
    <h3>Parse #{{forloop.counter}}</h3>
    <h4>MRS</h4>
    <pre><code>{{ parse.mrs.tostring }}</code></pre>
    <h4>DMRS</h4>
    <pre><code>{{ parse.dmrs.tostring }}</code></pre>
    {% endfor %}
  </div>
  <div id="xml" class="tab-pane">
    <pre><code>{{ sent.to_xml_str }}</code></pre>
  </div>
  <div id="json" class="tab-pane">
    {% for parse in sent %}
    <h3>Parse #{{forloop.counter}}</h3>
    <h4>MRS</h4>
    <pre><code>{{ parse.mrs.json_str }}</code></pre>
    <h4>DMRS</h4>
    <pre><code>{{ parse.dmrs.json_str }}</code></pre>
    {% endfor %}
  </div>
</div>
{% endif %}
{% endblock %}


{% block css %}
<style>
 .tab-pane {
   overflow-y: auto;
 }
</style>
<link rel="stylesheet" type="text/css" media="screen" href="{% static 'css/visko2.css' %}"/>
<link rel="stylesheet" type="text/css" media="screen" href="{% static 'viz/demo.css' %}"/>
<link rel="stylesheet" type="text/css" media="screen" href="{% static 'viz/delphin-viz.css' %}"/>
<link rel="stylesheet" href="{% static 'highlight.js/styles/github.css' %}">
{% endblock %}


{% block script %}
<script type="text/javascript" src="{% static 'viz/lodash-4.11.2.min.js' %}"></script>
<script type="text/javascript" src="{% static 'viz/svg-2.3.0.min.js' %}"></script>
<script type="text/javascript" src="{% static 'viz/d3.v3.min.js' %}" charset="utf-8"></script>
<script type="text/javascript" src="{% static 'viz/demo.js' %}"></script>
<script type="text/javascript" src="{% static 'viz/tree.js' %}"></script>
<script type="text/javascript" src="{% static 'viz/mrs.js' %}"></script>
<script type="text/javascript" src="{% static 'viz/dmrs.js' %}"></script>
<script src="{% static 'js/raphael.js' %}"></script>
<script src="{% static 'js/kajika.js' %}"></script>
<script src="{% static 'js/testutil.js' %}"></script>
<script src="{% static 'js/shinchan.js' %}"></script>
<script src="{% static 'js/visko-2.0.js' %}"></script>
<script src="{% static 'highlight.js/highlight-9.9.0.js' %}"></script>
<!-- Yawol client -->
<script src="{% static 'js/yawol.js' %}"></script>
<!-- Yawol support -->
<script type="text/template" id="synsetbox_template">
     <div class="synsetbox container-fluid well">
     <div class="row">
     <div class="col-xs-12">
      <button type="button" class="close" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
     </div>
     </div>
     <div class="row">
     <div class="col-xs-12 col-sm-2 col-md-2">
      <label>SynsetID</label>
     </div>
     <div class="col-xs-12 col-sm-2 col-md-2">
      <span class="synsetid"><%= synset.synsetid %></span>                
     </div>
     <div class="col-xs-12 col-sm-2 col-md-2">
      <label>Lemmas</label> <span class="lemma"></span>
     </div>
     <div class="col-xs-12 col-sm-6 col-md-6">
      <span class="lemmas"><%= _.join(synset.lemmas, ', ') %></span>
     </div>
     </div>
     <div class="row">
     <div class="col-xs-12 col-md-2">
      <label>Definition</label>
     </div>
     <div class="col-xs-12 col-md-10">
      <span class="definition"><%= synset.definition %></span>
     </div>
     </div>
     <div class="row">
     <div class="col-xs-12 col-md-2">
      <label>Examples</label>
     </div>
     <div class="col-xs-12 col-md-10">
       <span class="examples">
         <% if(synset.examples.length > 0) {  %>
         <ul>
           <% _.each(synset.examples, function(ex){ %>
           <li><%= ex %></li>
           <% }); %>
         </ul>
         <% } %>    
       </span>
     </div>
     </div>
     </div>
</script>
<script>
 var yawol;
 var yawol_root = '/yawol/';

 function get_yawol() {
   var yawol = undefined;
   if (yawol == undefined) {
     yawol = new Yawol("synsets", yawol_root, $("#synsetbox_template").html());
   }
   return yawol;
 }

 function find_synset(synsetid) {
   return function(){ 
     get_yawol().search_synset(synsetid);
   };
 }
</script>

<!-- MRS related scripts -->
<script>
 // delphin-viz visualisation
 function visualize(divid, text, dmrs_json, mrs_json){
   var vizdivtext = $('#dmrs_text_holder')      
   var $vizdiv = $('#' + divid);
   vizdivtext.text(text);
   $vizdiv.empty();
   var $viz = $(Templates.viz({vizType:'dmrs'})).appendTo($vizdiv);
   dmrs = DMRS($viz[0], dmrs_json);
   var $viz = $(Templates.viz({vizType:'mrs'})).appendTo($vizdiv);
   self.dmrs = MRS($viz[0], mrs_json, vizdivtext, '{{sent.text}}');
 }

 var console;
 $(document).ready(function(){
   {% if sent %}
   // MRS JSON data
   {% autoescape off %}
   {% for parse in sent %}
   //   Parse #{{forloop.counter}}
   dmrs_json{{forloop.counter}} = {{parse.dmrs.json_str}};
   mrs_json{{forloop.counter}} = {{parse.mrs.json_str}};
   {% endfor %}
   {% endautoescape %}
   
   // visualise delviz
   {% for parse in sent %}
   visualize('viszone{{forloop.counter}}', '{% autoescape off %}{{ sentence.text }}{% endautoescape %}', dmrs_json{{forloop.counter}}, mrs_json{{forloop.counter}});
   {% endfor %}
   
   // visualise Visko
   // but only when activated ...
   {% for parse in sent %}
   // visko_dmrs{{forloop.counter}} = json2visko(dmrs_json{{forloop.counter}}, "{{ sent.text }}", yawol_link_builder);
   dmrs_canvas{{forloop.counter}} = json2canvas(dmrs_json{{forloop.counter}}, "dmrs{{forloop.counter}}", find_synset);
   {% endfor %}
   visko_visualised = false;
   $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
     var target = $(e.target).attr("href");
     if(target == '#visko'){
       alert('boo visko');
       if (!visko_visualised){
         visko_visualised = true;
         {% for parse in sent %}
         dmrs_canvas{{forloop.counter}}.visualise();
         {% endfor %}
       }
     }
     else if (target == '#delviz'){
       // rerender delviz?
     }
     else{
       $(target).find('pre code').each(function(i, block) {
         hljs.highlightBlock(block);
       });
     }
   });
   {% endif %}
   
 });
</script>
{% endblock %}
