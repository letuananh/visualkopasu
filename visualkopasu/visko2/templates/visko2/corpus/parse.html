{% extends 'visko2/base.html' %}
{% load staticfiles %}

{% block content %}

<ol class="breadcrumb">
  <li class="breadcrumb-item"><a href="{% url 'visko2:list_collection' %}">Collections</a></li>
  <li class="breadcrumb-item"><a href="{% url 'visko2:list_corpus' collection_name=collection_name %}">{{ collection_name }}</a></li>
  <li class="breadcrumb-item"><a href="{% url 'visko2:list_doc' collection_name=collection_name corpus_name=corpus.name %}">{{ corpus.name }}</a></li>
  <li class="breadcrumb-item"><a href="{% url 'visko2:list_sent' collection_name=collection_name corpus_name=corpus.name doc_id=doc.ID %}">{{ doc.name }}</a></li>
  <li class="breadcrumb-item"><a href="{% url 'visko2:list_parse' collection_name=collection_name corpus_name=corpus.name doc_id=doc.ID sent_id=sent_id %}">Sent #{{ sent_id }}</a></li>
  <li class="breadcrumb-item">Parse #{{parse.ident}}</li>
</ol>

{% if sent %}
<h3>Sentence #{{sent_id}} | Parse #{{parse.ident}}</h3>
<div id="dmrs_text_holder" class="dmrs_sentence_text">{{ sent.text }}</div>

<div style="overflow-y: auto; height: 500px;">
  <ul class="nav nav-tabs">
    <li><a data-toggle="tab" href="#visko">DMRS</a></li>
    <li class="active"><a data-toggle="tab" href="#delviz">delphin-viz</a></li>
    <li><a data-toggle="tab" href="#raw">RAW</a></li>
    <li><a data-toggle="tab" href="#xml">XML</a></li>
    <li><a data-toggle="tab" href="#json">JSON</a></li>
    <li><a data-toggle="tab" href="#edit">Edit</a></li>
  </ul>
  <div class="tab-content">
    <div id="visko" class="tab-pane">
      <h3>Visko</h3>
      <div id='dmrs_canvas'></div>
    </div>
    <div id="delviz" class="tab-pane active">
      <div id='viszone'></div>
    </div>
    <div id="raw" class="tab-pane">
      <pre><code>{{ parse.dmrs_str }}</code></pre>
    </div>
    <div id="xml" class="tab-pane">
      <pre><code>{{ parse.dmrs_xml_str }}</code></pre>
    </div>
    <div id="json" class="tab-pane">
      <h4>MRS</h4>
      <pre><code>{{ parse.mrs_json_str }}</code></pre>
      <h4>DMRS</h4>
      <pre><code>{{ parse.sense_tag_json_str }}</code></pre>
    </div>
    <div id="edit" class="tab-pane">
      <h3>Edit</h3>
      <form>
        <div class="form-group">
          <label for="comment">DMRS RAW</label>
          <textarea class="form-control" rows="10" id="comment">{{parse.dmrs_str}}</textarea>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}


{% block css %}
<style>
 .tab-pane {
   overflow: auto;
 }
 textarea {
   font-family: "Courier New", Courier, monospace;
 }
</style>
<link rel="stylesheet" type="text/css" media="screen" href="{% static 'css/visko2.css' %}"/>
<link rel="stylesheet" type="text/css" media="screen" href="{% static 'viz/demo.css' %}"/>
<link rel="stylesheet" type="text/css" media="screen" href="{% static 'viz/delphin-viz.css' %}"/>
<link rel="stylesheet" href="{% static 'highlight.js/styles/github.css' %}">
{% endblock %}


{% block script %}
<script type="text/javascript" src="{% static 'viz/lodash-4.11.2.min.js' %}"></script>
<script type="text/javascript" src="{% static 'viz/svg-2.3.0.min.js' %}"></script>
<script type="text/javascript" src="{% static 'viz/d3.v3.min.js' %}" charset="utf-8"></script>
<script type="text/javascript" src="{% static 'viz/demo.js' %}"></script>
<script type="text/javascript" src="{% static 'viz/tree.js' %}"></script>
<script type="text/javascript" src="{% static 'viz/mrs.js' %}"></script>
<script type="text/javascript" src="{% static 'viz/dmrs.js' %}"></script>
<script src="{% static 'js/visualisation_v3.js' %}"></script>
<script src="{% static 'js/raphael.js' %}"></script>
<script src="{% static 'js/kajika.js' %}"></script>
<script src="{% static 'js/testutil.js' %}"></script>
<script src="{% static 'js/shinchan.js' %}"></script>
<script src="{% static 'highlight.js/highlight-9.9.0.js' %}"></script>


<script>
 function visualize(divid, text, dmrs_json, mrs_json){
   var vizdivtext = $('#dmrs_text_holder')      
   var $vizdiv = $('#' + divid);
   vizdivtext.text(text);
   $vizdiv.empty();
   var $viz = $(Templates.viz({vizType:'dmrs'})).appendTo($vizdiv);
   dmrs = DMRS($viz[0], dmrs_json);
   var $viz = $(Templates.viz({vizType:'mrs'})).appendTo($vizdiv);
   self.dmrs = MRS($viz[0], mrs_json, vizdivtext, '{{sent.text}}');
 }

 var console;
 $(document).ready(function(){
   {% if sent %}
   // MRS JSON data
   {% autoescape off %}
   // All parses
   dmrs_json = {{parse.sense_tag_json_str}};
   mrs_json = {{parse.mrs_json_str}};
   {% endautoescape %}
   // visualise delviz
   visualize('viszone', '{% autoescape off %}{{ sent.text }}{% endautoescape %}', dmrs_json, mrs_json);
   
   // visualise Visko
   // but only when activated ...
   console = new Console('console');
   visko_dmrs = json2visko(dmrs_json, "{{ sent.text }}");
   visual_dmrs = new VisualKopasu.DMRSCanvas(visko_dmrs, "dmrs_canvas", "dmrs_text_holder");
   visko_visualised = false;
   $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
     var target = $(e.target).attr("href");
     if(target == '#visko'){
       if (!visko_visualised){
         visko_visualised = true;
         visual_dmrs.visualise();
       }
     }
     else if (target == '#delviz'){
       // rerender delviz?
     }
     else{
       $(target).find('pre code').each(function(i, block) {
         hljs.highlightBlock(block);
       });
     }
   });
   {% endif %}
   
 });
</script>
{% endblock %}
