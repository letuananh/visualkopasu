{% extends 'visko2/base.html' %}
{% load staticfiles %}
{% load visko2_tags %}

{% block content %}

<ol class="breadcrumb">
  <li class="breadcrumb-item"><a href="{% url 'visko2:list_collection' %}">Collections</a></li>
  <li class="breadcrumb-item"><a href="{% url 'visko2:list_corpus' collection_name=collection_name %}">{{ collection_name }}</a></li>
  <li class="breadcrumb-item"><a href="{% url 'visko2:list_doc' collection_name=collection_name corpus_name=corpus.name %}">{{ corpus.name }}</a></li>
  <li class="breadcrumb-item"><a href="{% url 'visko2:list_sent' collection_name=collection_name corpus_name=corpus.name doc_id=doc.ID %}">{{ doc.name }}</a></li>
  <li class="breadcrumb-item"><a href="{% url 'visko2:list_parse' collection_name=collection_name corpus_name=corpus.name doc_id=doc.ID sent_id=sent_id %}">Sent #{{ sent_id }}</a></li>
  <li class="breadcrumb-item">Parse #{{parse.ident}}</li>
</ol>

{% if sent %}
<h3>Sentence #{{sent_id}} | Parse #{{parse.ident}}</h3>
<div id="dmrs_text_holder" class="dmrs_sentence_text">{{ sent.text }}</div>

  <ul class="nav nav-tabs">
    <li><a data-toggle="tab" href="#visko">DMRS</a></li>
    <li class="active"><a data-toggle="tab" href="#delviz">delphin-viz</a></li>
    <li><a data-toggle="tab" href="#raw">pyDelphin</a></li>
    <li><a data-toggle="tab" href="#xml">XML</a></li>
    <li><a data-toggle="tab" href="#json">JSON</a></li>
  </ul>
  <div class="tab-content">
    <div id="visko" class="tab-pane">
      <div style="overflow-y: auto; height: 700px;">
        <div id='dmrs_canvas'></div>
      </div>
    </div>
    <div id="delviz" class="tab-pane active">
      <div style="overflow-y: auto; height: 700px;">
        <div id='viszone'></div>
        <h3>Edit DMRS</h3>
        <form method="POST" action="{% url 'visko2:edit_parse' collection_name=collection_name corpus_name=corpus.name doc_id=doc.ID sent_id=sent_id parse_id=parse.ID mode='edit' %}">
          {% csrf_token %}
          <div class="form-group">
            <textarea class="form-control" rows="23" name="dmrs_raw" id="dmrs_raw">{{vdmrs}}</textarea>
          </div>
          <button type="submit" name="btn_action" value="parse" class="btn btn-lg btn-primary">Parse</button>
          <button type="submit" name="btn_action" value="insert" class="btn btn-lg btn-primary">Save As New DMRS</button>
          <button type="submit" name="btn_action" value="save" class="btn btn-lg btn-danger">Overwrite</button>
          <button type="button" class="btn btn-lg btn-danger" data-idx="{{parse.ident}}" data-href="{% url 'visko2:edit_parse' collection_name=collection_name corpus_name=corpus.name doc_id=doc.ID sent_id=sent_id parse_id=parse.ID mode='delete' %}" data-toggle="modal" data-target="#confirm-delete">Delete</button>
        </form>
      </div>
    </div>
    <div id="raw" class="tab-pane">
      <h3>pydelphin DMRS</h3>
      <pre><code>{{ parse.dmrs.tostring }}</code></pre>
    </div>
    <div id="xml" class="tab-pane">
      <pre><code>{{ parse.dmrs.xml_str|pretty_xml }}</code></pre>
    </div>
    <div id="json" class="tab-pane">
      <h4>MRS</h4>
      <pre><code>{{ parse.mrs.json_str }}</code></pre>
      <h4>DMRS</h4>
      <pre><code>{{ parse.dmrs.json_str }}</code></pre>
    </div>
  </div>
  {% endif %}

  <div class="modal fade" id="confirm-delete" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title" id="myModalLabel">Confirm Delete</h4>
        </div>
        
        <div class="modal-body">
          <p>You are about to delete the following parse, this procedure is irreversible.</p>
          <p>Do you want to proceed?</p>
          <p class="debug-url"></p>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
          <a class="btn btn-danger btn-ok">Delete</a>
        </div>
      </div>
    </div>
  </div>
{% endblock %}


{% block css %}
<style>
 .tab-pane {
   overflow: auto;
 }
 textarea {
   font-family: "Courier New", Courier, monospace;
 }
</style>
<link rel="stylesheet" type="text/css" media="screen" href="{% static 'css/visko2.css' %}"/>
<link rel="stylesheet" type="text/css" media="screen" href="{% static 'viz/demo.css' %}"/>
<link rel="stylesheet" type="text/css" media="screen" href="{% static 'viz/delphin-viz.css' %}"/>
<link rel="stylesheet" href="{% static 'highlight.js/styles/github.css' %}">
{% endblock %}


{% block script %}
<script type="text/javascript" src="{% static 'viz/lodash-4.11.2.min.js' %}"></script>
<script type="text/javascript" src="{% static 'viz/svg-2.3.0.min.js' %}"></script>
<script type="text/javascript" src="{% static 'viz/d3.v3.min.js' %}" charset="utf-8"></script>
<script type="text/javascript" src="{% static 'viz/demo.js' %}"></script>
<script type="text/javascript" src="{% static 'viz/tree.js' %}"></script>
<script type="text/javascript" src="{% static 'viz/mrs.js' %}"></script>
<script type="text/javascript" src="{% static 'viz/dmrs.js' %}"></script>
<script src="{% static 'js/raphael.js' %}"></script>
<script src="{% static 'js/kajika.js' %}"></script>
<script src="{% static 'js/testutil.js' %}"></script>
<script src="{% static 'js/shinchan.js' %}"></script>
<script src="{% static 'js/visko-2.0.js' %}"></script>
<script src="{% static 'highlight.js/highlight-9.9.0.js' %}"></script>


<script>
 function visualize(divid, text, dmrs_json, mrs_json){
   var vizdivtext = $('#dmrs_text_holder')      
   var $vizdiv = $('#' + divid);
   vizdivtext.text(text);
   $vizdiv.empty();
   var $viz = $(Templates.viz({vizType:'dmrs'})).appendTo($vizdiv);
   dmrs = DMRS($viz[0], dmrs_json);
   var $viz = $(Templates.viz({vizType:'mrs'})).appendTo($vizdiv);
   self.dmrs = MRS($viz[0], mrs_json, vizdivtext, '{{sent.text}}');
 }

 var console;
 $(document).ready(function(){
   {% if sent %}
   // MRS JSON data
   {% autoescape off %}
   // All parses
   dmrs_json = {{parse.dmrs.json_str}};
   mrs_json = {{parse.mrs.json_str}};
   {% endautoescape %}
   // visualise delviz
   visualize('viszone', '{% autoescape off %}{{ sent.text }}{% endautoescape %}', dmrs_json, mrs_json);
   
   // visualise Visko
   // but only when activated ...
   console = new Console('console');
   visko_dmrs = json2visko(dmrs_json, "{{ sent.text }}");
   visual_dmrs = new VisualKopasu.DMRSCanvas(visko_dmrs, "dmrs_canvas", "dmrs_text_holder");
   visko_visualised = false;
   $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
     var target = $(e.target).attr("href");
     if(target == '#visko'){
       if (!visko_visualised){
         visko_visualised = true;
         visual_dmrs.visualise();
       }
     }
     else if (target == '#delviz'){
       // rerender delviz?
     }
     else{
       $(target).find('pre code').each(function(i, block) {
         hljs.highlightBlock(block);
       });
     }
   });
   {% endif %}
   
 });
</script>
<script>
 $('#confirm-delete').on('show.bs.modal', function(e) {
   var lnk = $(e.relatedTarget).data('href');
   var idx = $(e.relatedTarget).data('idx');
   $(this).find('.btn-ok').attr('href', $(e.relatedTarget).data('href'));
   
   $('.debug-url').html('Delete URL: <strong>' + lnk + '</strong><br/>' + ' (Sentence #' + idx + ')');
 });
</script>
{% endblock %}
