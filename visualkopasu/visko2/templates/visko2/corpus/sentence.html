{% extends 'visko2/base.html' %}
{% load staticfiles %}

{% block content %}

<ol class="breadcrumb">
  <li class="breadcrumb-item"><a href="{% url 'visko2:list_collection' %}">Collections</a></li>
  <li class="breadcrumb-item"><a href="{% url 'visko2:list_corpus' collection_name=col %}">{{ col }}</a></li>
  <li class="breadcrumb-item"><a href="{% url 'visko2:list_doc' collection_name=col corpus_name=corpus.name %}">{{ corpus.name }}</a></li>
  <li class="breadcrumb-item"><a href="{% url 'visko2:list_sent' collection_name=col corpus_name=corpus.name doc_id=doc.ID %}">{{ doc.name }}</a></li>
  <li class="breadcrumb-item">Sent #{{ sid }}</li>
</ol>

{% if sent != None %}
<div class="dmrs_sentence_text">Parse count: <span id="parse_count">0</span></div>
<div id="sentence_text" class="dmrs_sentence_text"></div>

<!-- Synset Information -->
<div id="synsets"></div>

<ul id="alltabs" class="nav nav-tabs">
  <li class="active"><a data-toggle="tab" href="#visko">DMRS</a></li>
  <li><a data-toggle="tab" href="#delviz">delphin-viz</a></li>
  <li><a data-toggle="tab" href="#raw">pyDelphin</a></li>
  <li><a data-toggle="tab" href="#xml">XML</a></li>
  <li><a data-toggle="tab" href="#json">JSON</a></li>
</ul>
<div class="tab-content">
  <div id="visko" class="tab-pane active">
    <div style="overflow-y: auto; height: 600px;">
      <!-- DMRSes container -->
      <div id="dmrses"></div>
    </div>
  </div>
  <div id="delviz" class="tab-pane">
    <!-- Delphin-viz container -->
    <div id="dvizes"></div>
  </div>
  <div id="raw" class="tab-pane">
    <div id="raws"></div>
  </div>
  <div id="xml" class="tab-pane">
    <pre><code id="xmlcontent"></code></pre>
  </div>
  <div id="json" class="tab-pane">
    <div id="jsons"></div>
  </div>
</div>

{% else %}
There is no parse for this sentence.
{% endif %}
{% endblock %}


{% block css %}
<style>
 .tab-pane {
   overflow: auto;
 }
</style>
<link rel="stylesheet" type="text/css" media="screen" href="{% static 'css/visko2.css' %}"/>
<link rel="stylesheet" type="text/css" media="screen" href="{% static 'viz/demo.css' %}"/>
<link rel="stylesheet" type="text/css" media="screen" href="{% static 'viz/delphin-viz.css' %}"/>
<link rel="stylesheet" href="{% static 'highlight.js/styles/github.css' %}">
{% endblock %}


{% block script %}
<!-- Others -->
<script type="text/javascript" src="{% static 'js/lodash-4.17.4.min.js' %}"></script>
<script src="{% static 'highlight.js/highlight-9.9.0.js' %}"></script>
<!-- Delviz support -->
<script type="text/javascript" src="{% static 'viz/svg-2.3.0.min.js' %}"></script>
<script type="text/javascript" src="{% static 'viz/d3.v3.min.js' %}" charset="utf-8"></script>
<script type="text/javascript" src="{% static 'viz/demo.js' %}"></script>
<script type="text/javascript" src="{% static 'viz/tree.js' %}"></script>
<script type="text/javascript" src="{% static 'viz/mrs.js' %}"></script>
<script type="text/javascript" src="{% static 'viz/dmrs.js' %}"></script>
<!-- ShinchanJS -->
<script src="{% static 'js/raphael-2.2.1.min.js' %}"></script>
<script src="{% static 'js/kajika.js' %}"></script>
<script src="{% static 'js/console.js' %}"></script>
<script src="{% static 'js/shinchan.js' %}"></script>
<script src="{% static 'js/visko-2.0.js' %}"></script>
<script src="{% static 'js/restisf.js' %}"></script>

{% include 'visko2/yawol.html' %}
{% include 'visko2/delviz.html' %}

<!-- Visko REST -->
<script>
 var sent_url = "{% url 'visko2:list_parse' collection_name=col corpus_name=corpus.name doc_id=doc.ID sent_id=sid %}";
 var sent_data_url = "{% url 'visko2:rest_sent_fetch' col=col cor=corpus.name did=doc.name sid=sid %}";
 function fetch_visko() {   
   $.ajax({ url: sent_data_url,
            dataType: 'jsonp',
            data: { 'raw': true, 'xml': true, 'json': true },
            success: function(json){
              clear_parses();
              response = json;
              $('#parse_count').text(json.parses.length);
              visualise();
            },
            fail: function(jqxhr){
              if (console != undefined && console.writeline != undefined) {
                console.writeline("Request Failed: " + jqxhr.statusText + " | code = " + jqxhr.status);
              }
            },
            error: function(jqxhr){
              if (console != undefined && console.writeline != undefined) {
                console.writeline("An error occurred. Message = " + jqxhr.statusText + " | code = " + jqxhr.status);
              }
            }
   }); // end .ajax()
 }
</script>

<!-- Coolisf REST support -->
<script>
 var response = undefined;
 
 function clear_parses() {
   $('#dmrses').empty();
   $('#jsons').empty();
   $('#dvizes').empty();
   response = undefined;
 }
 
 function highlight(a_div) {
   $(a_div).find('pre code').each(function(i, block) {
     hljs.highlightBlock(block);
   });
 }

 function active_tab() {
   return $("#alltabs .active > a").attr("href");
 }

 /**
  * Make parse header clickable
  **/
 function header_toolbar(parse, parseidx, container) {
   var h3 = add_parse_header(parse, parseidx, container);
   var lnk = $('<a href="#"></a>');
   lnk.attr('href', sent_url + '/' + parse.pid);
   lnk.text(h3.text());
   h3.text('').append(lnk);
 }
 
 // Render active visualizer
 function visualise(){       
   if (response == undefined) {
     return;
   }
   var parses = $(response['parses']);
   // if using delviz
   if ($('#dvizes').is(':empty') && active_tab() == '#delviz'){
     parses.each(function(idx, parse){
       pid = idx + 1;
       render_delviz(parse, pid);
     });
   }
   // if using visko
   else if ($('#dmrses').is(':empty') && active_tab() == '#visko'){
     parses.each(function(idx, parse){
       pid = idx + 1;
       render_visko(parse, pid, header_toolbar);
     });
   }
   // XML
   else if ($('#xmlcontent').is(':empty') && active_tab() == '#xml') {
     display_xml(response.xml);
   }
   // Raws
   else if ($('#raws').is(':empty') && active_tab() == '#raw') {
     parses.each(function(idx, parse){
       pid = idx + 1;
       display_raw(parse, pid);
     });
     highlight('#raws');
   }       
   // JSONs
   else if ($('#jsons').is(':empty') && active_tab() == '#json') {
     parses.each(function(idx, parse){
       pid = idx + 1;
       display_json(parse, pid);
     });
     highlight('#jsons');
   }
   // end if
 }
</script>

<!-- Document ready -->
<script> 
 function initialise(){
   $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
     visualise();
   });
 }
 
 $(document).ready(function(){       
   initialise();
   fetch_visko();
 });
</script>
{% endblock %}
